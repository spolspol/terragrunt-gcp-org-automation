name: Manage SQL Instance

on:
  workflow_dispatch:
    inputs:
      sql_instance:
        description: 'SQL instance to manage (project/instance format)'
        required: true
        type: choice
        options:
          # Example project SQL instances
          - org-dev-01/sql-server-01
          - org-prod-01/sql-server-main
      action:
        description: 'Action to perform on the SQL instance'
        required: true
        type: choice
        options:
          - deploy
          - destroy
        default: deploy

concurrency:
  group: manage-sql-instance
  cancel-in-progress: false

jobs:
  get-env:
    name: üìã Setup ENV
    uses: ./.github/workflows/common-env.yml

  validate-inputs:
    name: üîç Validate Inputs
    runs-on: ubuntu-latest
    outputs:
      instance-path: ${{ steps.validate.outputs.instance-path }}
      instance-display-name: ${{ steps.validate.outputs.instance-display-name }}
      project-name: ${{ steps.validate.outputs.project-name }}
      action-confirmed: ${{ steps.validate.outputs.action-confirmed }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate inputs and find SQL instance path
        id: validate
        run: |
          SQL_INSTANCE="${{ inputs.sql_instance }}"
          ACTION="${{ inputs.action }}"

          echo "üîç Validating SQL instance inputs..."
          echo "SQL instance: $SQL_INSTANCE"
          echo "Action: $ACTION"

          # Parse project and instance name from project/instance format
          if ! echo "$SQL_INSTANCE" | grep -q "/"; then
            echo "‚ùå Invalid SQL instance format. Expected 'project/instance-name' format."
            echo "Valid formats: org-dev-01/sql-server-01, org-prod-01/sql-server-main"
            exit 1
          fi

          PROJECT=$(echo "$SQL_INSTANCE" | cut -d'/' -f1)
          INSTANCE_NAME=$(echo "$SQL_INSTANCE" | cut -d'/' -f2)

          echo "Parsed project: $PROJECT"
          echo "Parsed instance: $INSTANCE_NAME"

          # Validate project and instance format
          if ! echo "$PROJECT" | grep -E "^[a-z0-9-]+$" > /dev/null; then
            echo "‚ùå Invalid project name format. Use lowercase letters, numbers, and hyphens only."
            exit 1
          fi

          if ! echo "$INSTANCE_NAME" | grep -E "^[a-z0-9-]+$" > /dev/null; then
            echo "‚ùå Invalid instance name format. Use lowercase letters, numbers, and hyphens only."
            exit 1
          fi

          # Validate project and SQL instance combination
          case "$PROJECT" in
            "org-dev-01"|"org-prod-01")
              case "$INSTANCE_NAME" in
                "sql-server-01")
                  echo "‚úÖ Valid Compute SQL Server instance: $INSTANCE_NAME in project $PROJECT"
                  ;;
                *)
                  echo "‚ùå SQL instance '$INSTANCE_NAME' does not exist in project '$PROJECT'"
                  echo "Valid SQL instances for $PROJECT: sql-server-01"
                  exit 1
                  ;;
              esac
              ;;
            *)
              echo "‚ùå Unknown project: $PROJECT"
              echo "Available projects with SQL instances: org-dev-01, org-prod-01"
              exit 1
              ;;
          esac

          echo "‚úÖ Project and SQL instance combination validated"

          # Find the Compute VM SQL instance path
          echo "üîç Searching for Compute SQL Server instance: $INSTANCE_NAME in project: $PROJECT"

          INSTANCE_PATH=""

          # Look for Compute VM paths: live/**/compute/<instance_name>/vm/
          for path in $(find live -type d -path "*/compute/$INSTANCE_NAME/vm" 2>/dev/null || true); do
            if [ -f "$path/terragrunt.hcl" ]; then
              # Verify the path contains the correct project
              if echo "$path" | grep -q "/$PROJECT/"; then
                INSTANCE_PATH="$path"
                echo "‚úÖ Found Compute SQL Server instance at: $INSTANCE_PATH"
                break
              fi
            fi
          done

          if [ -z "$INSTANCE_PATH" ]; then
            echo "‚ùå Compute SQL Server instance '$INSTANCE_NAME' not found in project '$PROJECT'"
            echo "Available SQL instances by project:"
            echo "  org-dev-01: sql-server-01"
            echo "  org-prod-01: sql-server-main"
            exit 1
          fi

          # No destroy confirmation required for SQL VM instances
          ACTION_CONFIRMED="true"
          if [ "$ACTION" == "destroy" ]; then
            echo "‚ö†Ô∏è DESTROY action for SQL VM instance: $INSTANCE_NAME in project: $PROJECT"
            echo "‚ÑπÔ∏è No confirmation required - VM instances can be safely destroyed and recreated"
            echo "‚ÑπÔ∏è This will destroy only the VM instance, not the instance template"
          else
            echo "‚úÖ DEPLOY action for SQL VM instance: $INSTANCE_NAME in project: $PROJECT"
          fi

          # Set outputs
          echo "instance-path=$INSTANCE_PATH" >> $GITHUB_OUTPUT
          echo "instance-display-name=$INSTANCE_NAME" >> $GITHUB_OUTPUT
          echo "project-name=$PROJECT" >> $GITHUB_OUTPUT
          echo "action-confirmed=$ACTION_CONFIRMED" >> $GITHUB_OUTPUT

          echo "‚úÖ SQL instance validation completed successfully"

  execute-action:
    name: "${{ inputs.action == 'destroy' && 'üóëÔ∏è' || 'üöÄ' }} ${{ inputs.action == 'destroy' && 'Destroy' || 'Deploy' }}: ${{ needs.validate-inputs.outputs.instance-display-name }} (${{ needs.validate-inputs.outputs.project-name }})"
    runs-on: ubuntu-latest
    needs: [get-env, validate-inputs]
    env:
      TERRAGRUNT_VERSION: ${{ needs.get-env.outputs.terragrunt_version }}
      TOFU_VERSION: ${{ needs.get-env.outputs.tofu_version }}
      GCP_PROJECT_ID: ${{ needs.get-env.outputs.gcp_project_id }}
      GCP_REGION: ${{ needs.get-env.outputs.gcp_region }}
      TG_EXPERIMENT_MODE: ${{ needs.get-env.outputs.tg_experiment_mode }}
      TG_NON_INTERACTIVE: ${{ needs.get-env.outputs.tg_non_interactive }}
      TG_BACKEND_BOOTSTRAP: ${{ needs.get-env.outputs.tg_backend_bootstrap }}
    if: needs.validate-inputs.outputs.action-confirmed == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Cache Terragrunt and OpenTofu binaries
        id: cache-binaries
        uses: actions/cache@v4
        with:
          path: |
            ~/.local/bin/terragrunt
            ~/.local/bin/tofu
          key: terragrunt-${{ env.TERRAGRUNT_VERSION }}-tofu-${{ env.TOFU_VERSION }}-${{ runner.os }}
          restore-keys: |
            terragrunt-${{ env.TERRAGRUNT_VERSION }}-tofu-${{ env.TOFU_VERSION }}-
            terragrunt-${{ env.TERRAGRUNT_VERSION }}-

      - name: Setup Terragrunt and OpenTofu
        if: steps.cache-binaries.outputs.cache-hit != 'true'
        run: |
          # Create local bin directory
          mkdir -p ~/.local/bin

          # Install Terragrunt
          echo "üì• Downloading Terragrunt v${{ env.TERRAGRUNT_VERSION }}..."
          wget -O ~/.local/bin/terragrunt https://github.com/gruntwork-io/terragrunt/releases/download/v${{ env.TERRAGRUNT_VERSION }}/terragrunt_linux_amd64
          chmod +x ~/.local/bin/terragrunt

          # Install OpenTofu
          echo "üì• Downloading OpenTofu v${{ env.TOFU_VERSION }}..."
          wget -O tofu.tar.gz https://github.com/opentofu/opentofu/releases/download/v${{ env.TOFU_VERSION }}/tofu_${{ env.TOFU_VERSION }}_linux_amd64.tar.gz
          tar -xzf tofu.tar.gz
          chmod +x tofu
          mv tofu ~/.local/bin/
          rm tofu.tar.gz

          echo "‚úÖ Binaries downloaded and cached"

      - name: Add binaries to PATH and verify
        run: |
          # Add to PATH for this job
          echo "$HOME/.local/bin" >> $GITHUB_PATH
          export PATH="$HOME/.local/bin:$PATH"

          # Verify installations
          echo "üîç Verifying installations..."
          terragrunt --version
          tofu --version
          echo "‚úÖ All binaries verified"

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.TF_GOOGLE_CREDENTIALS }}

      - name: Pre-execution validation
        working-directory: ${{ needs.validate-inputs.outputs.instance-path }}
        run: |
          echo "üîç Pre-execution validation for: ${{ needs.validate-inputs.outputs.instance-display-name }} (Compute SQL Server) in project: ${{ needs.validate-inputs.outputs.project-name }}"
          echo "Working directory: ${{ needs.validate-inputs.outputs.instance-path }}"
          echo "Action: ${{ inputs.action }}"

          # Verify terragrunt.hcl exists
          if [ ! -f "terragrunt.hcl" ]; then
            echo "‚ùå terragrunt.hcl not found in current directory"
            exit 1
          fi

          # Show configuration summary
          echo "üìã Configuration file found:"
          ls -la terragrunt.hcl

          # Validate HCL syntax
          echo "üîç Validating HCL configuration..."
          terragrunt hcl validate

          echo "‚úÖ Pre-execution validation completed"

      - name: Initialize Terragrunt
        working-directory: ${{ needs.validate-inputs.outputs.instance-path }}
        run: |
          echo "üîß Initializing Terragrunt for: ${{ needs.validate-inputs.outputs.instance-display-name }} (Compute SQL Server) in project: ${{ needs.validate-inputs.outputs.project-name }}"
          terragrunt run init
          echo "‚úÖ Terragrunt initialization completed"

      - name: "${{ inputs.action == 'destroy' && 'Plan Destroy' || 'Plan Deploy' }}"
        id: plan
        working-directory: ${{ needs.validate-inputs.outputs.instance-path }}
        run: |
          echo "üìã Planning ${{ inputs.action }} for: ${{ needs.validate-inputs.outputs.instance-display-name }} (Compute SQL Server) in project: ${{ needs.validate-inputs.outputs.project-name }}"

          # Prepare plan file name
          export PLAN_TIMESTAMP=$(date -u +%Y%m%dT%H%M%SZ)
          export PLAN_FILE_NAME="${PLAN_TIMESTAMP}-${{ inputs.action }}-${{ needs.validate-inputs.outputs.project-name }}-${{ needs.validate-inputs.outputs.instance-display-name }}.plan"

          echo "Plan file name: $PLAN_FILE_NAME"

          set +e
          if [ "${{ inputs.action }}" == "destroy" ]; then
            echo "üóëÔ∏è Planning destroy operation..."
            terragrunt run plan -- -destroy -detailed-exitcode -compact-warnings -no-color | tee "$PLAN_FILE_NAME"
          else
            echo "üöÄ Planning deploy operation..."
            terragrunt run plan -- -detailed-exitcode -compact-warnings -no-color | tee "$PLAN_FILE_NAME"
          fi

          PLAN_EXIT_CODE=${PIPESTATUS[0]}
          TEE_EXIT_CODE=${PIPESTATUS[1]}
          set -e

          echo "Terragrunt plan exit code: $PLAN_EXIT_CODE"
          echo "Tee exit code: $TEE_EXIT_CODE"
          echo "Plan output file size: $(wc -l < "$PLAN_FILE_NAME" 2>/dev/null || echo 0) lines"

          # Show plan summary
          echo "üìã Plan Summary (first 20 lines):"
          head -20 "$PLAN_FILE_NAME" || echo "Could not read plan output"
          echo "üìã Plan Summary (last 20 lines):"
          tail -20 "$PLAN_FILE_NAME" || echo "Could not read plan output"

          if [ $PLAN_EXIT_CODE -eq 0 ]; then
            echo "result=no-changes" >> $GITHUB_OUTPUT
            echo "‚úÖ No changes detected"
          elif [ $PLAN_EXIT_CODE -eq 2 ]; then
            echo "result=changes-detected" >> $GITHUB_OUTPUT
            echo "‚úÖ Changes detected - ready for execution"
          else
            echo "result=error" >> $GITHUB_OUTPUT
            echo "‚ùå Terragrunt plan failed with exit code: $PLAN_EXIT_CODE"
            exit 1
          fi

      - name: "${{ inputs.action == 'destroy' && 'Execute Destroy' || 'Execute Deploy' }}"
        id: execute
        working-directory: ${{ needs.validate-inputs.outputs.instance-path }}
        if: steps.plan.outputs.result == 'changes-detected'
        run: |
          echo "${{ inputs.action == 'destroy' && 'üóëÔ∏è Executing DESTROY' || 'üöÄ Executing DEPLOY' }} for: ${{ needs.validate-inputs.outputs.instance-display-name }} (Compute SQL Server) in project: ${{ needs.validate-inputs.outputs.project-name }}"

          set +e
          if [ "${{ inputs.action }}" == "destroy" ]; then
            echo "üóëÔ∏è Destroying Compute SQL Server VM instance: ${{ needs.validate-inputs.outputs.instance-display-name }} in project: ${{ needs.validate-inputs.outputs.project-name }}"
            echo "‚ÑπÔ∏è This will destroy only the VM instance, leaving the instance template intact"
            echo "‚ÑπÔ∏è The instance template can be used to recreate the VM with the same configuration"
            terragrunt run destroy -- -auto-approve
          else
            echo "üöÄ Deploying Compute SQL Server VM instance: ${{ needs.validate-inputs.outputs.instance-display-name }} in project: ${{ needs.validate-inputs.outputs.project-name }}"
            echo "‚ÑπÔ∏è This will create a VM instance using the existing instance template"
            terragrunt run apply -- -auto-approve
          fi

          ACTION_EXIT_CODE=$?
          set -e

          if [ $ACTION_EXIT_CODE -eq 0 ]; then
            echo "‚úÖ ${{ inputs.action == 'destroy' && 'Destroy' || 'Deploy' }} completed successfully for: ${{ needs.validate-inputs.outputs.instance-display-name }} (Compute SQL Server) in project: ${{ needs.validate-inputs.outputs.project-name }}"
            echo "result=success" >> $GITHUB_OUTPUT
          else
            echo "‚ùå ${{ inputs.action == 'destroy' && 'Destroy' || 'Deploy' }} failed with exit code: $ACTION_EXIT_CODE for: ${{ needs.validate-inputs.outputs.instance-display-name }} (Compute SQL Server) in project: ${{ needs.validate-inputs.outputs.project-name }}"
            echo "result=error" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Show No Changes Message
        if: steps.plan.outputs.result == 'no-changes'
        run: |
          echo "‚ÑπÔ∏è No changes detected for Compute SQL Server instance: ${{ needs.validate-inputs.outputs.instance-display-name }} in project: ${{ needs.validate-inputs.outputs.project-name }}"
          echo "The current state matches the desired configuration."
          if [ "${{ inputs.action }}" == "destroy" ]; then
            echo "The SQL instance may already be destroyed or not exist."
          else
            echo "The SQL instance is already up-to-date."
          fi

  summary:
    name: üìä Execution Summary
    runs-on: ubuntu-latest
    needs: [validate-inputs, execute-action]
    if: always()
    steps:
      - name: Generate execution summary
        run: |
          VALIDATION_STATUS="${{ needs.validate-inputs.result }}"
          EXECUTION_STATUS="${{ needs.execute-action.result }}"
          PROJECT_NAME="${{ needs.validate-inputs.outputs.project-name }}"
          SQL_INSTANCE="${{ needs.validate-inputs.outputs.instance-display-name }}"
          ACTION="${{ inputs.action }}"

          echo "## üóÑÔ∏è SQL Instance Management Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Determine overall status
          if [ "$VALIDATION_STATUS" == "success" ] && [ "$EXECUTION_STATUS" == "success" ]; then
            echo "üü¢ **Status: SUCCESS** ‚úÖ" >> $GITHUB_STEP_SUMMARY
            OVERALL_STATUS="success"
          elif [ "$VALIDATION_STATUS" == "failure" ]; then
            echo "üî¥ **Status: VALIDATION FAILED** ‚ùå" >> $GITHUB_STEP_SUMMARY
            OVERALL_STATUS="validation_failed"
          elif [ "$EXECUTION_STATUS" == "failure" ]; then
            echo "üî¥ **Status: EXECUTION FAILED** ‚ùå" >> $GITHUB_STEP_SUMMARY
            OVERALL_STATUS="execution_failed"
          elif [ "$EXECUTION_STATUS" == "skipped" ]; then
            echo "üü° **Status: NO CHANGES** ‚ÑπÔ∏è" >> $GITHUB_STEP_SUMMARY
            OVERALL_STATUS="no_changes"
          else
            echo "üü° **Status: UNKNOWN** ‚ùì" >> $GITHUB_STEP_SUMMARY
            OVERALL_STATUS="unknown"
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Project:** $PROJECT_NAME" >> $GITHUB_STEP_SUMMARY
          echo "**SQL Instance:** $SQL_INSTANCE" >> $GITHUB_STEP_SUMMARY
          echo "**Instance Type:** COMPUTE SQL SERVER" >> $GITHUB_STEP_SUMMARY
          echo "**Action:** ${ACTION^^}" >> $GITHUB_STEP_SUMMARY
          echo "**Path:** \`${{ needs.validate-inputs.outputs.instance-path }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Workflow:** [View Details](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Show step results
          echo "### üìã Step Results:" >> $GITHUB_STEP_SUMMARY
          echo "| Step | Status | Result |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|--------|" >> $GITHUB_STEP_SUMMARY

          # Validation step
          if [ "$VALIDATION_STATUS" == "success" ]; then
            echo "| üîç Input Validation | ‚úÖ PASSED | SQL instance found and validated |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| üîç Input Validation | ‚ùå FAILED | Invalid inputs or SQL instance not found |" >> $GITHUB_STEP_SUMMARY
          fi

          # Execution step
          if [ "$EXECUTION_STATUS" == "success" ]; then
            echo "| ${{ inputs.action == 'destroy' && 'üóëÔ∏è' || 'üöÄ' }} ${{ inputs.action == 'destroy' && 'Destroy' || 'Deploy' }} Execution | ‚úÖ COMPLETED | SQL infrastructure ${{ inputs.action }}ed successfully |" >> $GITHUB_STEP_SUMMARY
          elif [ "$EXECUTION_STATUS" == "failure" ]; then
            echo "| ${{ inputs.action == 'destroy' && 'üóëÔ∏è' || 'üöÄ' }} ${{ inputs.action == 'destroy' && 'Destroy' || 'Deploy' }} Execution | ‚ùå FAILED | Execution encountered errors |" >> $GITHUB_STEP_SUMMARY
          elif [ "$EXECUTION_STATUS" == "skipped" ]; then
            echo "| ${{ inputs.action == 'destroy' && 'üóëÔ∏è' || 'üöÄ' }} ${{ inputs.action == 'destroy' && 'Destroy' || 'Deploy' }} Execution | ‚è∏Ô∏è SKIPPED | No changes detected |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| ${{ inputs.action == 'destroy' && 'üóëÔ∏è' || 'üöÄ' }} ${{ inputs.action == 'destroy' && 'Destroy' || 'Deploy' }} Execution | ‚ùì UNKNOWN | Unexpected status |" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY

          # Show appropriate next steps based on status
          case "$OVERALL_STATUS" in
            "success")
              echo "### ‚úÖ Success - Next Steps:" >> $GITHUB_STEP_SUMMARY
              if [ "$ACTION" == "destroy" ]; then
                echo "- **üóëÔ∏è SQL Server VM destroyed** - The Compute SQL Server VM instance has been permanently removed" >> $GITHUB_STEP_SUMMARY
                echo "- **üîç Verify in GCP Console** - Confirm the VM no longer appears in Compute Engine" >> $GITHUB_STEP_SUMMARY
                echo "- **üí∞ Cost savings** - Billing for this SQL Server VM instance has stopped" >> $GITHUB_STEP_SUMMARY
                echo "- **üóÑÔ∏è Data backup** - Ensure any important data was backed up before destruction" >> $GITHUB_STEP_SUMMARY
                echo "- **üìù Instance template preserved** - The instance template remains intact and can be used to recreate the VM" >> $GITHUB_STEP_SUMMARY
              else
                echo "- **üöÄ SQL Server instance deployed** - The Compute SQL Server instance is now running and ready" >> $GITHUB_STEP_SUMMARY
                echo "- **üîç Verify in GCP Console** - Check the VM status in Compute Engine" >> $GITHUB_STEP_SUMMARY
                echo "- **üåê Connect to instance** - Use RDP to access the Windows SQL Server instance" >> $GITHUB_STEP_SUMMARY
                echo "- **üóÑÔ∏è SQL Server** - Complete SQL Server configuration and create databases as needed" >> $GITHUB_STEP_SUMMARY
                echo "- **üîê Credentials** - Use the stored secrets for SQL Server admin access" >> $GITHUB_STEP_SUMMARY
              fi
              ;;
            "validation_failed")
              echo "### ‚ùå Validation Failed - Next Steps:" >> $GITHUB_STEP_SUMMARY
              echo "- **üîç Check SQL instance name** - Ensure the instance name exists in the repository" >> $GITHUB_STEP_SUMMARY
              echo "- **üìã Available instances** - Review the validation logs for available SQL instances" >> $GITHUB_STEP_SUMMARY
              echo "- **üîß Fix input errors** - Correct any input validation issues and re-run" >> $GITHUB_STEP_SUMMARY
              echo "- **‚öôÔ∏è Instance type** - This workflow only supports Compute SQL Server instances" >> $GITHUB_STEP_SUMMARY
              ;;
            "execution_failed")
              echo "### ‚ùå Execution Failed - Next Steps:" >> $GITHUB_STEP_SUMMARY
              echo "- **üìã Review logs** - Check the execution step logs for detailed error information" >> $GITHUB_STEP_SUMMARY
              echo "- **üîß Fix configuration** - Address any Terragrunt or infrastructure issues" >> $GITHUB_STEP_SUMMARY
              echo "- **üóÑÔ∏è SQL dependencies** - Verify all required SQL Server dependencies are available" >> $GITHUB_STEP_SUMMARY
              echo "- **üîÑ Retry operation** - Re-run the workflow after fixing issues" >> $GITHUB_STEP_SUMMARY
              ;;
            "no_changes")
              echo "### ‚ÑπÔ∏è No Changes - Next Steps:" >> $GITHUB_STEP_SUMMARY
              echo "- **‚úÖ SQL instance up-to-date** - No changes were needed" >> $GITHUB_STEP_SUMMARY
              echo "- **üîç Verify state** - The current state matches the desired configuration" >> $GITHUB_STEP_SUMMARY
              if [ "$ACTION" == "destroy" ]; then
                echo "- **‚ùì Already destroyed** - The SQL instance may already be destroyed" >> $GITHUB_STEP_SUMMARY
              fi
              ;;
          esac

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**üóÑÔ∏è SQL Instance Management Notes:**" >> $GITHUB_STEP_SUMMARY
          echo "- **No confirmation required** - SQL instances can be safely destroyed and recreated" >> $GITHUB_STEP_SUMMARY
          echo "- **Data persistence** - Ensure critical data is backed up before destruction" >> $GITHUB_STEP_SUMMARY
          echo "- **Instance types** - Supports Compute Engine SQL Server instances only" >> $GITHUB_STEP_SUMMARY
          echo "- **Security** - All actions are logged and auditable through GitHub Actions" >> $GITHUB_STEP_SUMMARY
          echo "- **Access control** - Only authorized users with repository access can trigger this workflow" >> $GITHUB_STEP_SUMMARY
